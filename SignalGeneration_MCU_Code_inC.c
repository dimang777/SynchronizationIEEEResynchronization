/*****************************************************************************
 * @file main_dac_voltage.c
 * @brief Digital to Analog converter, output voltage example
 * @author Silicon Labs modified by Isaac Sung Jae Chang
 * Project Name: STK3800_dac_voltage_Isaac2_2
 * Hardware: EFM32WG990F256
 * @version 1.11
 ******************************************************************************
 * @section License
 * <b>(C) Copyright 2014 Silicon Labs, http://www.silabs.com</b>
 *******************************************************************************
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 * 1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software.
 * 2. Altered source versions must be plainly marked as such, and must not be
 *    misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 *
 * DISCLAIMER OF WARRANTY/LIMITATION OF REMEDIES: Silicon Labs has no
 * obligation to support this Software. Silicon Labs is providing the
 * Software "AS IS", with no express or implied warranties of any kind,
 * including, but not limited to, any implied warranties of merchantability
 * or fitness for any particular purpose or warranties against infringement
 * of any proprietary rights of a third party.
 *
 * Silicon Labs will not be liable for any consequential, incidental, or
 * special damages, or any other relief, or for any claim by any third party,
 * arising from your use of this Software.
 *
 ******************************************************************************/
#include <stdint.h>
#include <stdbool.h>

#include "em_device.h"
#include "em_chip.h"
#include "em_cmu.h"
#include "em_emu.h"
#include "em_dac.h"


#include "em_gpio.h"
#include "em_system.h"
#include "em_timer.h"


#define NO_OF_VoltStates       7 //0.5, 1.0, 1.5, 2.0, 2.5, 3.0
//Matlab code to get uint32 values
//vector = uint32((([0.5, 1.0, 1.5, 2.0, 2.5, 3.0].* 4096) ./ 3.3))
// Result: 621	1241	1862	2482	3103	3724
static const uint32_t VoltStatesArray[ NO_OF_VoltStates ] = {621, 1241, 1862, 2482, 3103, 3724, 0};

static const int PermutationMat[720][6] = {{1,2,3,4,5,6},{1,2,3,4,6,5},{1,2,3,5,4,6},{1,2,3,5,6,4},{1,2,3,6,4,5},{1,2,3,6,5,4},{1,2,4,3,5,6},{1,2,4,3,6,5},{1,2,4,5,3,6},{1,2,4,5,6,3},{1,2,4,6,3,5},{1,2,4,6,5,3},{1,2,5,3,4,6},{1,2,5,3,6,4},{1,2,5,4,3,6},{1,2,5,4,6,3},{1,2,5,6,3,4},{1,2,5,6,4,3},{1,2,6,3,4,5},{1,2,6,3,5,4},{1,2,6,4,3,5},{1,2,6,4,5,3},{1,2,6,5,3,4},{1,2,6,5,4,3},{1,3,2,4,5,6},{1,3,2,4,6,5},{1,3,2,5,4,6},{1,3,2,5,6,4},{1,3,2,6,4,5},{1,3,2,6,5,4},{1,3,4,2,5,6},{1,3,4,2,6,5},{1,3,4,5,2,6},{1,3,4,5,6,2},{1,3,4,6,2,5},{1,3,4,6,5,2},{1,3,5,2,4,6},{1,3,5,2,6,4},{1,3,5,4,2,6},{1,3,5,4,6,2},{1,3,5,6,2,4},{1,3,5,6,4,2},{1,3,6,2,4,5},{1,3,6,2,5,4},{1,3,6,4,2,5},{1,3,6,4,5,2},{1,3,6,5,2,4},{1,3,6,5,4,2},{1,4,2,3,5,6},{1,4,2,3,6,5},{1,4,2,5,3,6},{1,4,2,5,6,3},{1,4,2,6,3,5},{1,4,2,6,5,3},{1,4,3,2,5,6},{1,4,3,2,6,5},{1,4,3,5,2,6},{1,4,3,5,6,2},{1,4,3,6,2,5},{1,4,3,6,5,2},{1,4,5,2,3,6},{1,4,5,2,6,3},{1,4,5,3,2,6},{1,4,5,3,6,2},{1,4,5,6,2,3},{1,4,5,6,3,2},{1,4,6,2,3,5},{1,4,6,2,5,3},{1,4,6,3,2,5},{1,4,6,3,5,2},{1,4,6,5,2,3},{1,4,6,5,3,2},{1,5,2,3,4,6},{1,5,2,3,6,4},{1,5,2,4,3,6},{1,5,2,4,6,3},{1,5,2,6,3,4},{1,5,2,6,4,3},{1,5,3,2,4,6},{1,5,3,2,6,4},{1,5,3,4,2,6},{1,5,3,4,6,2},{1,5,3,6,2,4},{1,5,3,6,4,2},{1,5,4,2,3,6},{1,5,4,2,6,3},{1,5,4,3,2,6},{1,5,4,3,6,2},{1,5,4,6,2,3},{1,5,4,6,3,2},{1,5,6,2,3,4},{1,5,6,2,4,3},{1,5,6,3,2,4},{1,5,6,3,4,2},{1,5,6,4,2,3},{1,5,6,4,3,2},{1,6,2,3,4,5},{1,6,2,3,5,4},{1,6,2,4,3,5},{1,6,2,4,5,3},{1,6,2,5,3,4},{1,6,2,5,4,3},{1,6,3,2,4,5},{1,6,3,2,5,4},{1,6,3,4,2,5},{1,6,3,4,5,2},{1,6,3,5,2,4},{1,6,3,5,4,2},{1,6,4,2,3,5},{1,6,4,2,5,3},{1,6,4,3,2,5},{1,6,4,3,5,2},{1,6,4,5,2,3},{1,6,4,5,3,2},{1,6,5,2,3,4},{1,6,5,2,4,3},{1,6,5,3,2,4},{1,6,5,3,4,2},{1,6,5,4,2,3},{1,6,5,4,3,2},{2,1,3,4,5,6},{2,1,3,4,6,5},{2,1,3,5,4,6},{2,1,3,5,6,4},{2,1,3,6,4,5},{2,1,3,6,5,4},{2,1,4,3,5,6},{2,1,4,3,6,5},{2,1,4,5,3,6},{2,1,4,5,6,3},{2,1,4,6,3,5},{2,1,4,6,5,3},{2,1,5,3,4,6},{2,1,5,3,6,4},{2,1,5,4,3,6},{2,1,5,4,6,3},{2,1,5,6,3,4},{2,1,5,6,4,3},{2,1,6,3,4,5},{2,1,6,3,5,4},{2,1,6,4,3,5},{2,1,6,4,5,3},{2,1,6,5,3,4},{2,1,6,5,4,3},{2,3,1,4,5,6},{2,3,1,4,6,5},{2,3,1,5,4,6},{2,3,1,5,6,4},{2,3,1,6,4,5},{2,3,1,6,5,4},{2,3,4,1,5,6},{2,3,4,1,6,5},{2,3,4,5,1,6},{2,3,4,5,6,1},{2,3,4,6,1,5},{2,3,4,6,5,1},{2,3,5,1,4,6},{2,3,5,1,6,4},{2,3,5,4,1,6},{2,3,5,4,6,1},{2,3,5,6,1,4},{2,3,5,6,4,1},{2,3,6,1,4,5},{2,3,6,1,5,4},{2,3,6,4,1,5},{2,3,6,4,5,1},{2,3,6,5,1,4},{2,3,6,5,4,1},{2,4,1,3,5,6},{2,4,1,3,6,5},{2,4,1,5,3,6},{2,4,1,5,6,3},{2,4,1,6,3,5},{2,4,1,6,5,3},{2,4,3,1,5,6},{2,4,3,1,6,5},{2,4,3,5,1,6},{2,4,3,5,6,1},{2,4,3,6,1,5},{2,4,3,6,5,1},{2,4,5,1,3,6},{2,4,5,1,6,3},{2,4,5,3,1,6},{2,4,5,3,6,1},{2,4,5,6,1,3},{2,4,5,6,3,1},{2,4,6,1,3,5},{2,4,6,1,5,3},{2,4,6,3,1,5},{2,4,6,3,5,1},{2,4,6,5,1,3},{2,4,6,5,3,1},{2,5,1,3,4,6},{2,5,1,3,6,4},{2,5,1,4,3,6},{2,5,1,4,6,3},{2,5,1,6,3,4},{2,5,1,6,4,3},{2,5,3,1,4,6},{2,5,3,1,6,4},{2,5,3,4,1,6},{2,5,3,4,6,1},{2,5,3,6,1,4},{2,5,3,6,4,1},{2,5,4,1,3,6},{2,5,4,1,6,3},{2,5,4,3,1,6},{2,5,4,3,6,1},{2,5,4,6,1,3},{2,5,4,6,3,1},{2,5,6,1,3,4},{2,5,6,1,4,3},{2,5,6,3,1,4},{2,5,6,3,4,1},{2,5,6,4,1,3},{2,5,6,4,3,1},{2,6,1,3,4,5},{2,6,1,3,5,4},{2,6,1,4,3,5},{2,6,1,4,5,3},{2,6,1,5,3,4},{2,6,1,5,4,3},{2,6,3,1,4,5},{2,6,3,1,5,4},{2,6,3,4,1,5},{2,6,3,4,5,1},{2,6,3,5,1,4},{2,6,3,5,4,1},{2,6,4,1,3,5},{2,6,4,1,5,3},{2,6,4,3,1,5},{2,6,4,3,5,1},{2,6,4,5,1,3},{2,6,4,5,3,1},{2,6,5,1,3,4},{2,6,5,1,4,3},{2,6,5,3,1,4},{2,6,5,3,4,1},{2,6,5,4,1,3},{2,6,5,4,3,1},{3,1,2,4,5,6},{3,1,2,4,6,5},{3,1,2,5,4,6},{3,1,2,5,6,4},{3,1,2,6,4,5},{3,1,2,6,5,4},{3,1,4,2,5,6},{3,1,4,2,6,5},{3,1,4,5,2,6},{3,1,4,5,6,2},{3,1,4,6,2,5},{3,1,4,6,5,2},{3,1,5,2,4,6},{3,1,5,2,6,4},{3,1,5,4,2,6},{3,1,5,4,6,2},{3,1,5,6,2,4},{3,1,5,6,4,2},{3,1,6,2,4,5},{3,1,6,2,5,4},{3,1,6,4,2,5},{3,1,6,4,5,2},{3,1,6,5,2,4},{3,1,6,5,4,2},{3,2,1,4,5,6},{3,2,1,4,6,5},{3,2,1,5,4,6},{3,2,1,5,6,4},{3,2,1,6,4,5},{3,2,1,6,5,4},{3,2,4,1,5,6},{3,2,4,1,6,5},{3,2,4,5,1,6},{3,2,4,5,6,1},{3,2,4,6,1,5},{3,2,4,6,5,1},{3,2,5,1,4,6},{3,2,5,1,6,4},{3,2,5,4,1,6},{3,2,5,4,6,1},{3,2,5,6,1,4},{3,2,5,6,4,1},{3,2,6,1,4,5},{3,2,6,1,5,4},{3,2,6,4,1,5},{3,2,6,4,5,1},{3,2,6,5,1,4},{3,2,6,5,4,1},{3,4,1,2,5,6},{3,4,1,2,6,5},{3,4,1,5,2,6},{3,4,1,5,6,2},{3,4,1,6,2,5},{3,4,1,6,5,2},{3,4,2,1,5,6},{3,4,2,1,6,5},{3,4,2,5,1,6},{3,4,2,5,6,1},{3,4,2,6,1,5},{3,4,2,6,5,1},{3,4,5,1,2,6},{3,4,5,1,6,2},{3,4,5,2,1,6},{3,4,5,2,6,1},{3,4,5,6,1,2},{3,4,5,6,2,1},{3,4,6,1,2,5},{3,4,6,1,5,2},{3,4,6,2,1,5},{3,4,6,2,5,1},{3,4,6,5,1,2},{3,4,6,5,2,1},{3,5,1,2,4,6},{3,5,1,2,6,4},{3,5,1,4,2,6},{3,5,1,4,6,2},{3,5,1,6,2,4},{3,5,1,6,4,2},{3,5,2,1,4,6},{3,5,2,1,6,4},{3,5,2,4,1,6},{3,5,2,4,6,1},{3,5,2,6,1,4},{3,5,2,6,4,1},{3,5,4,1,2,6},{3,5,4,1,6,2},{3,5,4,2,1,6},{3,5,4,2,6,1},{3,5,4,6,1,2},{3,5,4,6,2,1},{3,5,6,1,2,4},{3,5,6,1,4,2},{3,5,6,2,1,4},{3,5,6,2,4,1},{3,5,6,4,1,2},{3,5,6,4,2,1},{3,6,1,2,4,5},{3,6,1,2,5,4},{3,6,1,4,2,5},{3,6,1,4,5,2},{3,6,1,5,2,4},{3,6,1,5,4,2},{3,6,2,1,4,5},{3,6,2,1,5,4},{3,6,2,4,1,5},{3,6,2,4,5,1},{3,6,2,5,1,4},{3,6,2,5,4,1},{3,6,4,1,2,5},{3,6,4,1,5,2},{3,6,4,2,1,5},{3,6,4,2,5,1},{3,6,4,5,1,2},{3,6,4,5,2,1},{3,6,5,1,2,4},{3,6,5,1,4,2},{3,6,5,2,1,4},{3,6,5,2,4,1},{3,6,5,4,1,2},{3,6,5,4,2,1},{4,1,2,3,5,6},{4,1,2,3,6,5},{4,1,2,5,3,6},{4,1,2,5,6,3},{4,1,2,6,3,5},{4,1,2,6,5,3},{4,1,3,2,5,6},{4,1,3,2,6,5},{4,1,3,5,2,6},{4,1,3,5,6,2},{4,1,3,6,2,5},{4,1,3,6,5,2},{4,1,5,2,3,6},{4,1,5,2,6,3},{4,1,5,3,2,6},{4,1,5,3,6,2},{4,1,5,6,2,3},{4,1,5,6,3,2},{4,1,6,2,3,5},{4,1,6,2,5,3},{4,1,6,3,2,5},{4,1,6,3,5,2},{4,1,6,5,2,3},{4,1,6,5,3,2},{4,2,1,3,5,6},{4,2,1,3,6,5},{4,2,1,5,3,6},{4,2,1,5,6,3},{4,2,1,6,3,5},{4,2,1,6,5,3},{4,2,3,1,5,6},{4,2,3,1,6,5},{4,2,3,5,1,6},{4,2,3,5,6,1},{4,2,3,6,1,5},{4,2,3,6,5,1},{4,2,5,1,3,6},{4,2,5,1,6,3},{4,2,5,3,1,6},{4,2,5,3,6,1},{4,2,5,6,1,3},{4,2,5,6,3,1},{4,2,6,1,3,5},{4,2,6,1,5,3},{4,2,6,3,1,5},{4,2,6,3,5,1},{4,2,6,5,1,3},{4,2,6,5,3,1},{4,3,1,2,5,6},{4,3,1,2,6,5},{4,3,1,5,2,6},{4,3,1,5,6,2},{4,3,1,6,2,5},{4,3,1,6,5,2},{4,3,2,1,5,6},{4,3,2,1,6,5},{4,3,2,5,1,6},{4,3,2,5,6,1},{4,3,2,6,1,5},{4,3,2,6,5,1},{4,3,5,1,2,6},{4,3,5,1,6,2},{4,3,5,2,1,6},{4,3,5,2,6,1},{4,3,5,6,1,2},{4,3,5,6,2,1},{4,3,6,1,2,5},{4,3,6,1,5,2},{4,3,6,2,1,5},{4,3,6,2,5,1},{4,3,6,5,1,2},{4,3,6,5,2,1},{4,5,1,2,3,6},{4,5,1,2,6,3},{4,5,1,3,2,6},{4,5,1,3,6,2},{4,5,1,6,2,3},{4,5,1,6,3,2},{4,5,2,1,3,6},{4,5,2,1,6,3},{4,5,2,3,1,6},{4,5,2,3,6,1},{4,5,2,6,1,3},{4,5,2,6,3,1},{4,5,3,1,2,6},{4,5,3,1,6,2},{4,5,3,2,1,6},{4,5,3,2,6,1},{4,5,3,6,1,2},{4,5,3,6,2,1},{4,5,6,1,2,3},{4,5,6,1,3,2},{4,5,6,2,1,3},{4,5,6,2,3,1},{4,5,6,3,1,2},{4,5,6,3,2,1},{4,6,1,2,3,5},{4,6,1,2,5,3},{4,6,1,3,2,5},{4,6,1,3,5,2},{4,6,1,5,2,3},{4,6,1,5,3,2},{4,6,2,1,3,5},{4,6,2,1,5,3},{4,6,2,3,1,5},{4,6,2,3,5,1},{4,6,2,5,1,3},{4,6,2,5,3,1},{4,6,3,1,2,5},{4,6,3,1,5,2},{4,6,3,2,1,5},{4,6,3,2,5,1},{4,6,3,5,1,2},{4,6,3,5,2,1},{4,6,5,1,2,3},{4,6,5,1,3,2},{4,6,5,2,1,3},{4,6,5,2,3,1},{4,6,5,3,1,2},{4,6,5,3,2,1},{5,1,2,3,4,6},{5,1,2,3,6,4},{5,1,2,4,3,6},{5,1,2,4,6,3},{5,1,2,6,3,4},{5,1,2,6,4,3},{5,1,3,2,4,6},{5,1,3,2,6,4},{5,1,3,4,2,6},{5,1,3,4,6,2},{5,1,3,6,2,4},{5,1,3,6,4,2},{5,1,4,2,3,6},{5,1,4,2,6,3},{5,1,4,3,2,6},{5,1,4,3,6,2},{5,1,4,6,2,3},{5,1,4,6,3,2},{5,1,6,2,3,4},{5,1,6,2,4,3},{5,1,6,3,2,4},{5,1,6,3,4,2},{5,1,6,4,2,3},{5,1,6,4,3,2},{5,2,1,3,4,6},{5,2,1,3,6,4},{5,2,1,4,3,6},{5,2,1,4,6,3},{5,2,1,6,3,4},{5,2,1,6,4,3},{5,2,3,1,4,6},{5,2,3,1,6,4},{5,2,3,4,1,6},{5,2,3,4,6,1},{5,2,3,6,1,4},{5,2,3,6,4,1},{5,2,4,1,3,6},{5,2,4,1,6,3},{5,2,4,3,1,6},{5,2,4,3,6,1},{5,2,4,6,1,3},{5,2,4,6,3,1},{5,2,6,1,3,4},{5,2,6,1,4,3},{5,2,6,3,1,4},{5,2,6,3,4,1},{5,2,6,4,1,3},{5,2,6,4,3,1},{5,3,1,2,4,6},{5,3,1,2,6,4},{5,3,1,4,2,6},{5,3,1,4,6,2},{5,3,1,6,2,4},{5,3,1,6,4,2},{5,3,2,1,4,6},{5,3,2,1,6,4},{5,3,2,4,1,6},{5,3,2,4,6,1},{5,3,2,6,1,4},{5,3,2,6,4,1},{5,3,4,1,2,6},{5,3,4,1,6,2},{5,3,4,2,1,6},{5,3,4,2,6,1},{5,3,4,6,1,2},{5,3,4,6,2,1},{5,3,6,1,2,4},{5,3,6,1,4,2},{5,3,6,2,1,4},{5,3,6,2,4,1},{5,3,6,4,1,2},{5,3,6,4,2,1},{5,4,1,2,3,6},{5,4,1,2,6,3},{5,4,1,3,2,6},{5,4,1,3,6,2},{5,4,1,6,2,3},{5,4,1,6,3,2},{5,4,2,1,3,6},{5,4,2,1,6,3},{5,4,2,3,1,6},{5,4,2,3,6,1},{5,4,2,6,1,3},{5,4,2,6,3,1},{5,4,3,1,2,6},{5,4,3,1,6,2},{5,4,3,2,1,6},{5,4,3,2,6,1},{5,4,3,6,1,2},{5,4,3,6,2,1},{5,4,6,1,2,3},{5,4,6,1,3,2},{5,4,6,2,1,3},{5,4,6,2,3,1},{5,4,6,3,1,2},{5,4,6,3,2,1},{5,6,1,2,3,4},{5,6,1,2,4,3},{5,6,1,3,2,4},{5,6,1,3,4,2},{5,6,1,4,2,3},{5,6,1,4,3,2},{5,6,2,1,3,4},{5,6,2,1,4,3},{5,6,2,3,1,4},{5,6,2,3,4,1},{5,6,2,4,1,3},{5,6,2,4,3,1},{5,6,3,1,2,4},{5,6,3,1,4,2},{5,6,3,2,1,4},{5,6,3,2,4,1},{5,6,3,4,1,2},{5,6,3,4,2,1},{5,6,4,1,2,3},{5,6,4,1,3,2},{5,6,4,2,1,3},{5,6,4,2,3,1},{5,6,4,3,1,2},{5,6,4,3,2,1},{6,1,2,3,4,5},{6,1,2,3,5,4},{6,1,2,4,3,5},{6,1,2,4,5,3},{6,1,2,5,3,4},{6,1,2,5,4,3},{6,1,3,2,4,5},{6,1,3,2,5,4},{6,1,3,4,2,5},{6,1,3,4,5,2},{6,1,3,5,2,4},{6,1,3,5,4,2},{6,1,4,2,3,5},{6,1,4,2,5,3},{6,1,4,3,2,5},{6,1,4,3,5,2},{6,1,4,5,2,3},{6,1,4,5,3,2},{6,1,5,2,3,4},{6,1,5,2,4,3},{6,1,5,3,2,4},{6,1,5,3,4,2},{6,1,5,4,2,3},{6,1,5,4,3,2},{6,2,1,3,4,5},{6,2,1,3,5,4},{6,2,1,4,3,5},{6,2,1,4,5,3},{6,2,1,5,3,4},{6,2,1,5,4,3},{6,2,3,1,4,5},{6,2,3,1,5,4},{6,2,3,4,1,5},{6,2,3,4,5,1},{6,2,3,5,1,4},{6,2,3,5,4,1},{6,2,4,1,3,5},{6,2,4,1,5,3},{6,2,4,3,1,5},{6,2,4,3,5,1},{6,2,4,5,1,3},{6,2,4,5,3,1},{6,2,5,1,3,4},{6,2,5,1,4,3},{6,2,5,3,1,4},{6,2,5,3,4,1},{6,2,5,4,1,3},{6,2,5,4,3,1},{6,3,1,2,4,5},{6,3,1,2,5,4},{6,3,1,4,2,5},{6,3,1,4,5,2},{6,3,1,5,2,4},{6,3,1,5,4,2},{6,3,2,1,4,5},{6,3,2,1,5,4},{6,3,2,4,1,5},{6,3,2,4,5,1},{6,3,2,5,1,4},{6,3,2,5,4,1},{6,3,4,1,2,5},{6,3,4,1,5,2},{6,3,4,2,1,5},{6,3,4,2,5,1},{6,3,4,5,1,2},{6,3,4,5,2,1},{6,3,5,1,2,4},{6,3,5,1,4,2},{6,3,5,2,1,4},{6,3,5,2,4,1},{6,3,5,4,1,2},{6,3,5,4,2,1},{6,4,1,2,3,5},{6,4,1,2,5,3},{6,4,1,3,2,5},{6,4,1,3,5,2},{6,4,1,5,2,3},{6,4,1,5,3,2},{6,4,2,1,3,5},{6,4,2,1,5,3},{6,4,2,3,1,5},{6,4,2,3,5,1},{6,4,2,5,1,3},{6,4,2,5,3,1},{6,4,3,1,2,5},{6,4,3,1,5,2},{6,4,3,2,1,5},{6,4,3,2,5,1},{6,4,3,5,1,2},{6,4,3,5,2,1},{6,4,5,1,2,3},{6,4,5,1,3,2},{6,4,5,2,1,3},{6,4,5,2,3,1},{6,4,5,3,1,2},{6,4,5,3,2,1},{6,5,1,2,3,4},{6,5,1,2,4,3},{6,5,1,3,2,4},{6,5,1,3,4,2},{6,5,1,4,2,3},{6,5,1,4,3,2},{6,5,2,1,3,4},{6,5,2,1,4,3},{6,5,2,3,1,4},{6,5,2,3,4,1},{6,5,2,4,1,3},{6,5,2,4,3,1},{6,5,3,1,2,4},{6,5,3,1,4,2},{6,5,3,2,1,4},{6,5,3,2,4,1},{6,5,3,4,1,2},{6,5,3,4,2,1},{6,5,4,1,2,3},{6,5,4,1,3,2},{6,5,4,2,1,3},{6,5,4,2,3,1},{6,5,4,3,1,2},{6,5,4,3,2,1}};



static int VoltState = 0;
static int PermuState = 0;
static int PermutationIndex[6] = {1,2,3,4,5,6};
static int Permutation[7] = {621, 1241, 1862, 2482, 3103, 3724, 0};
static int DutyCycleOn = 0;
static int UseDutyCycle = 0;
static int ProcessFlag = 0;
static uint32_t DAC_Value = 0;


/* Function prototypes */
void DAC_setup(void);
void DAC_WriteData(DAC_TypeDef *dac, unsigned int value, unsigned int ch);





/* 13671 Hz -> 14Mhz (clock frequency) / 1024 (prescaler)
  Setting TOP to 27342 results in an overflow each 2 seconds */
#define TOP 27342 //0.9s Duty cycle
#define TOP_DutyCycleOff 0 //0.1s off
#define TOP2 13671 //0.9s Duty cycle
#define TOP_DutyCycleOff2 13671 //0.1s off


/**************************************************************************//**
 * @brief TIMER0_IRQHandler
 * Interrupt Service Routine TIMER0 Interrupt Line
 *****************************************************************************/
void TIMER0_IRQHandler(void)
{
  /* Clear flag for TIMER0 overflow interrupt */
  TIMER_IntClear(TIMER0, TIMER_IF_OF);

  ProcessFlag = 1;

  if (ProcessFlag)
  	  {


  		  	  if(DutyCycleOn==0)
  		  	  {
  			VoltState++;
  			if (VoltState==NO_OF_VoltStates)
  			{
  				VoltState = 0;
  				PermuState++;
  				if (PermuState==760)
  				{
  					PermuState = 0;
  					if (UseDutyCycle==0)
  					{
  						UseDutyCycle = 1;
  					}
  					else
  					{
  						UseDutyCycle = 0;
  						TIMER_TopSet(TIMER0, TOP);
  					}
  				}
  				for (int i = 0; i < 6; i++) {
  					PermutationIndex[i] = PermutationMat[PermuState][i]-1;
  					Permutation[i] = VoltStatesArray[PermutationIndex[i]];
  				}
  				Permutation[6] = 0;


  			  }
  		  	  }


  			  if(UseDutyCycle)
  			  {
  				  /* Set TIMER Top value */
  				  if (DutyCycleOn)
  				  {
  					TIMER_TopSet(TIMER0, TOP_DutyCycleOff2);
  					DutyCycleOn = 0;
  					DAC_Value = 0;
  					DAC_WriteData(DAC0, DAC_Value, 0);
  				  }
  				  else
  				  {
  					TIMER_TopSet(TIMER0, TOP2);
  					DutyCycleOn = 1;
  					DAC_Value = Permutation[VoltState];

  					/* Write the new value to DAC register */
  					DAC_WriteData(DAC0, DAC_Value, 0);

  				  }
  			  }
  			  else
  			  {
  				  DAC_Value = Permutation[VoltState];

  				  			/* Write the new value to DAC register */
  				  			DAC_WriteData(DAC0, DAC_Value, 0);

  			  }



  			ProcessFlag = 0;
  	  }

}





/**************************************************************************//**
 * @brief  Main function
 * Setup of dac and calculating output value, enter em1 while dac is working
 *****************************************************************************/
int main(void)
{
  /* Initialize chip */
  CHIP_Init();

  //uint32_t DAC_Value;

  /* Initialise the DAC */
  DAC_setup();

  /* Enable DAC channel 0, located on pin PB11 */
  DAC_Enable(DAC0, 0, true);

  /* Calculate output to 0.1 V. */
  DAC_Value = VoltStatesArray[VoltState];

  /* Write the new value to DAC register */
  DAC_WriteData(DAC0, DAC_Value, 0);

  /* Enter EM1 while the DAC is doing continuous conversions. */
  //EMU_EnterEM1();




  /* Enable clock for TIMER0 module */
  CMU_ClockEnable(cmuClock_TIMER0, true);

  /* Select TIMER0 parameters */
  TIMER_Init_TypeDef timerInit =
  {
    .enable     = true,
    .debugRun   = true,
    .prescale   = timerPrescale1024,
    .clkSel     = timerClkSelHFPerClk,
    .fallAction = timerInputActionNone,
    .riseAction = timerInputActionNone,
    .mode       = timerModeUp,
    .dmaClrAct  = false,
    .quadModeX4 = false,
    .oneShot    = false,
    .sync       = false,
  };

  /* Enable overflow interrupt */
  TIMER_IntEnable(TIMER0, TIMER_IF_OF);

  /* Enable TIMER0 interrupt vector in NVIC */
  NVIC_EnableIRQ(TIMER0_IRQn);

  /* Set TIMER Top value */
  TIMER_TopSet(TIMER0, TOP);

  /* Configure TIMER */
  TIMER_Init(TIMER0, &timerInit);

  /* Infinite blink loop */
  while (1)
  {



  }

  /* Should never get here */
  return 0;
}


/**************************************************************************//**
 * @brief  Setup DAC
 * Configures and starts the DAC
 *****************************************************************************/
void DAC_setup(void)
{
  /* Use default settings */
  DAC_Init_TypeDef        init        = DAC_INIT_DEFAULT;
  DAC_InitChannel_TypeDef initChannel = DAC_INITCHANNEL_DEFAULT;

  /* Enable the DAC clock */
  CMU_ClockEnable(cmuClock_DAC0, true);

  // Set the drive mode of the port to maximum (20mA)
  GPIO_DriveModeSet(gpioPortB, gpioDriveModeHigh);

  /* Calculate the DAC clock prescaler value that will result in a DAC clock
   * close to 500kHz. Second parameter is zero, if the HFPERCLK value is 0, the
   * function will check what the current value actually is. */
  init.prescale = DAC_PrescaleCalc(500000, 0);

  /* Set reference voltage to Vdd */
  init.reference = dacRefVDD;

  /* Initialize the DAC and DAC channel. */
  DAC_Init(DAC0, &init);
  DAC_InitChannel(DAC0, &initChannel, 0);
}


/**************************************************************************//**
 * @brief  Write DAC conversion value
 *****************************************************************************/
void DAC_WriteData(DAC_TypeDef *dac, unsigned int value, unsigned int ch)
{
  /* Write data output value to the correct register. */
  if (!ch)
  {
    dac->CH0DATA = value;
  }
  else
  {
    dac->CH1DATA = value;
  }
}

